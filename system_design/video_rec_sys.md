1. Выяснение требований:

* Система предлагает персонализированную подборку видео для пользователей, которые заходят на главную страницу.
* Видеоролики, которые есть в системе, на разных языках.
* Можно рассчитывать на то, что получится построить датасет на основании взаимодействий пользователей с видеоконтентом
* Считаем, что плейлистов нет
* На платформе доступно порядка 10 млрд. видеороликов
* Система должна работать быстро: на рекомендацию должно уходить не более 200 миллисекунд

Резюмируя требования:

Нужно спроектировать систему, которая рекомендует видеоролики для каждого пользователя на главной странице.
Бизнес-цель состоит в том, чтобы увеличить вовлеченность пользователей.
Каждый раз, когда пользователь заходит на главную страницу, система рекомендует ему самые «вовлекающие» видеоролики.
Пользователи живут в разных странах, и видеоролики могут быть на разных языках.
На платформе доступно около 10 миллиардов роликов, и рекомендации должны предоставляться достаточно быстро.

2. Формулировка проблемы как задачи машинного обучения.

Бизнес-цель системы — повысить степень вовлеченности пользователей.
Преобразовать бизнес-цели в четко определенные цели МО можно несколькими способами.
Мы изучим некоторые из них и обсудим их достоинства и недостатки.

- Максимизировать количество кликов.
Систему рекомендации видео можно спроектировать так, чтобы достичь максимального количества кликов.
Однако у такого подхода есть серьезный недостаток: система может рекомендовать видеоролики из категории так называемого «кликбейта»: название и значок выглядят заманчиво, но содержимое видео оказывается скучным, нерелевантным и даже мошенническим. Кликбейтные видеоролики портят впечатление пользователей и со временем снижают их вовлеченность.

- Максимизировать количество роликов, просмотренных до конца.
Система также может рекомендовать видеоролики, которые пользователь с большой вероятностью досмотрит до конца. Главный недостаток этого решения — модель может рекомендовать более короткие видео, просмотр которых занимает меньше времени.

- Максимизировать общее время просмотра.
В этом случае рекомендуются видеоролики, за просмотром которых пользователи в сумме проведут больше времени.

- Максимизировать количество релевантных видеороликов.
В этом случае рекомендуются видеоролики, релевантные для пользователя. Разработчики или менеджеры продуктов могут определять релевантность по некоторым правилам, которые опираются на явные и неявные реакции пользователей. Например, можно считать видео релевантным, если пользователь нажал кнопку «лайк» или просмотрел не менее половины. Определив релевантность, можно построить набор данных и обучить модель предсказывать показатель релевантности для заданного пользователя и видео.

* Цель: максимизировать количество релевантных видеороликов.
* Определение выходных и выходных данных: на вход подается пользователь; на выходе -- ранжированный список видеороликов, отсортированных по релевантности.
* Выбор категории машинного обучения: сейчас буду рассмотрены три разновидности рекомендательных систем: фильтрация на основе содержимого; коллаборативная фильтрация; гибридная фильтрация.

<h1>Фильтрация на основе содержимого<h1/>
 Этот метод использует различные признаки видео, чтобы рекомендовать новые видеоролики, похожие на те, которые пользователь ранее посчитал релевантными. Например, если пользователь часто смотрел видео о лыжном спорте, этот метод может предсказать новые ролики на эту же тему. 
- Достоинства: 
 - Можно рекомендовать новые видео.
 С этим методом не нужно ждать данных о пользовательских взаимодействиях, чтобы формировать профили для новых видеороликов. Профиль видео зависит исключительно от признаков самого видео.
 - Учитываются уникальные интересы пользователей.
 Это связано с тем, что видеоролики рекомендуются на основании прошлых взаимодействий пользователей.
- Недостатки:
 - Трудно выявлять новые интересы пользователя
 - Метод требует знания предметной области. Признаки видео часто приходится конструировать вручную.

<h1> Коллаборативная фильтрация (Collaborative Filtering, CF)<h1/>
Чтобы рекомендовать новые видео, этот метод использует сходство между пользователями (CF на основе пользователей) или сходство между видеороликами (CF на основе единиц контента). Коллаборативная фильтрация опирается на интуитивно понятную идею о том, что похожих пользователей интересуют похожие видеоролики.

- Достоинства:
 - Не требуется знания предметной области. 
 Коллаборативная фильтрация не зависит от признаков видео, поэтому не требуется конструировать признаки на основе видео с учетом предметной области.
 - Легко выявлять новые интересы пользователей.
 Система может рекомендовать видео на новые темы, которыми похожие пользователи интересовались в прошлом.
 - Эффективность.
 Модели на базе CF обычно быстрее работают и менее требовательны к вычислительным ресурсам, чем фильтрация на основании содержимого, потому что они не зависят от признаков видео.

- Недостатки
 - Проблема «холодного старта».
 Так называется ситуация, когда для нового видео или пользователя доступно мало данных, отчего система не может выработать точные рекомендации. CF страдает от проблемы «холодного старта», когда нет исторических данных о взаимодействиях для новых пользователей или новых видео; это мешает находить похожих пользователей или похожие видео.
 - Трудно учитывать узкие интересы.
 Коллаборативная фильтрация плохо работает с пользователями, которые обладают специфическими или нишевыми интересами. Чтобы вырабатывать рекомендации, CF полагается на данные похожих пользователей, а найти похожего пользователя с такими же узкими интересами может быть трудно.

|                                    | Фильтрация на основе содержимого | Коллаборативная фильтрация |
|------------------------------------|---------------------------------|----------------------------|
| Обработка новых видео             | ✓                               | ✗                          |
| Обнаружение новых областей интересов | ✗                               | ✓                          |
| Не требуется знание предметной области | ✗                               | ✓                          |
| Эффективность                     | ✗                               | ✓                          |

<h1> Гибридная фильтрация<h1/>

Гибридная фильтрация совмещает CF и фильтрацию на основе содержимого. Гибридная фильтрация объединяет рекомендательные системы двух перечисленных типов последовательно или параллельно. В реальных системах обычно применяется последовательная гибридная фильтрация

Гибридный подход повышает качество рекомендаций, потому что использует два источника данных: историю пользовательских взаимодействий и признаки видео. Признаки видео позволяют системе рекомендовать релевантные видео на основании того, какие ролики пользователь просматривал в прошлом, а коллаборативная фильтрация помогает пользователям обнаруживать новые сферы интересов.

3. Подготовка данных.

* Доступны следующие данные: пользователи, взаимодействия пользователей с видеороликами, видеоролики
* Видео хранит информацию о: ID видео; Продолжительность; Теги, назначенные вручную; Название, введенное вручную; Лайки; Просмотры; Язык; т.д.
* Пользователь хранит информацию о: ID пользователя; Имя пользователя; Возраст; Пол; Город; Страна; Язык; Часовой пояс
* Взаимодействия пользователей с видео хранит информацию о: ID пользователя; ID видео; Тип взаимодействия; Значение взаимодействия; Геопозиция (широта, долгота); Временная метка.

* Конструирование признаков: 
- Признаки видео:
 - Идентификатор видео ( категориальный признак )
 - Продолжительность ( числовой признак )
 - Язык ( категориальный признак )
 - Названия и теги ( категориальный признак )

- Признаки пользователей
 - Демографические признаки ( категориальные признаки: возраст, пол, язык, страна, город )
 - Контекстная информация ( категориальные признаки: время суток, устройство, день недели )

- История взаимодействий пользователя
 - История поиска: Предыдущие поисковые запросы показывают, какие видеоролики пользователь смотрел раньше, а прошлое поведение нередко является индикатором будущего. ( усредненный эмбединг )
 - Понравившиеся видео: По тому, каким видеороликам пользователь ранее ставил лайки, можно судить о том, какой тип контента его интересует.
 - Просмотры и показы видео: как пункт выше

4. Разработка модели.

* Для рекоменадательных систем обычно применяют два подхода: матричная факторизация ( используется коллаборативной фильтрации ) ( учимся представлять пользователя и релевантные ролики в виде эмбедингов ) и двухбашенная (two-tower) нейронная сеть.
* Матричная факторизация
 - Явная и неявная обратная связь от пользователя ( лайки, пересылки | клики и время просмотра )
 - Для оптимизации матричной факторизации используется метод взвешенных чередующихся наименьших квадратов (WALS, Weighted Alternating Least Squares). Этот алгоритм специфичен для матричной факторизации и работает так:
 1) зафиксировать одну матрицу эмбеддингов (U) и оптимизировать другую матрицу (V);
 2) зафиксировать другую матрицу эмбеддингов (V) и оптимизировать первую (U);
 3) повторять пока не сойдемся до приемлемого результата.
 4) после обучения при добавлении новых данных используем инкрементное обучение
* Двухбашенная нейронная сеть
 - Обучаем для энкодера: для видео и для атрибутов пользователя. Потом сравниваем полученные эмбединги.

* Построение датасета: чтобы построить датасет, мы будем выделять признаки из разных пар ⟨ пользователь, видео ⟩ и помечать их как положительные или отрицательные в зависимости от обратной связи пользователя. Например, пара будет считаться положительной, если пользователь поставил лайк видеоролику или просмотрел его хотя бы наполовину. Чтобы построить отрицательные точки данных, можно выбрать либо случайные видеоролики, которые не должны быть релевантными, либо те, которым пользователь явно поставил дизлайк.

Для борьбы с дисбалансом классов можно прибегнуть к: семплированию минорного класса, урезанию мажоритарного класса, поменять метрику ( ROC-AUC, F-мера, etc. ), Focal loss, использование синтетики

* Выбор функции потерь: кросс-энтропия, потому что эмбединги должны максимально точно отражать суть | мб можно посмотреть в сторону контрастного обучения с triplet loss.

* Достоинства и недостатки двубашенной нейронной сети ( two tower neural network ):
 - Достоинства:
  - Задействуются признаки пользователей
  - Учитываются новые пользователи
 - Недостатки:
  - Низкая скорость обслуживания
  - Обучение более затратно

| Характеристика                | Матричная факторизация                          | Двухбашенная нейронная сеть                     |
|-------------------------------|------------------------------------------------|------------------------------------------------|
| **Затраты на обучение**       | Более эффективное обучение                     | Более затратное обучение                       |
| **Скорость обработки**        | Быстрее, потому что эмбеддинги являются статическими и могут вычисляться заранее | Признаки пользователей преобразуются в эмбеддинги во время запроса |
| **Проблема «холодного старта»** | Трудно обрабатывать новых пользователей       | Новые пользователи обрабатываются легко, потому что используются признаки пользователей |
| **Качество рекомендаций**     | Не идеально, потому что модель не использует признаки пользователей и видео | Более качественные рекомендации, потому что задействовано больше признаков |

5. Оценка.

* Оффлайн метрики:
 * Accuracy@k
 * mAP
 * Разнообразие (diversity) 
* Онлайн метрики: 
 * CTR
 * Количество просмотров до конца
 * Общее время просмотра
 * Явная обратная связь от пользователей

6. Экплуатация.

На стадии эксплуатации система рекомендует каждому пользователю самые релевантные видео, чтобы сузить выборку с миллиардов видеороликов до обозримого количества.

* Предсказательный пайплайн:

 * Генерация кандидатов
  * Используем слабую двубашенную сеть, чтобы отсеять огромный пул нерелевантных кандидатов и избежать проблему холодного старта ( можно использовать несколько нейронных сетей, чтобы под различные категории видео были различные результаты ( релевантные видео, популярные видео, злободневные видео, etc. ))
 * Скоринг
  * Используем более жирную модель с большим числом параметров, чтобы охватить как можно больше признаков и точнее отранжировать.
 * Повторное ранжирование
  * Фильтруем кликбейты, по свежести, региональным ограничениям, одинаковые видеоролики.

* Трудности:
 - Скорость обслуживания: при обработке сотен миллионов видеороликов важно ускорять инференс, так как ранжирование такого объема материала -- нетривиальная задача. Мы должны успешно справляться с ней при помощи предварительного ранжирования. Подобную систему использует YouTube.
  - Точность: точность обеспечивается благодаря скорингу: видео ранжируется с помощью мощной модели, которая основана на большем количестве признаков, включая признаки видео. Использование более мощной модели не ухудшает скорость обслуживания, потому что в результате генерации кандидатов выбирается относительно небольшое подмножество видео.
  - Разнообразие: многие пользователи предпочитают, чтобы рекомендации были разнообразными. Чтобы система создавала разнообразные подборки видео, мы применяем несколько генераторов кандидатов
  - Проблема «холодного старта»: когда пользователь только начинает работать с нашей платформой, данные о его взаимодействиях недоступны. В таком случае предсказания делаются с помощью двухбашенных нейронных сетей на основе таких признаков, как возраст, пол, язык, местонахождение и т. д. Рекомендованные видео до определенной степени персонализируются даже для новых пользователей. По мере того как пользователь взаимодействует с большим количеством видео, мы можем делать более точные предсказания на основе новых взаимодействий.

Important links:
* https://blog.youtube/inside-youtube/on-youtubes-recommendation-system/
* https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/45530.pdf
* https://ai.facebook.com/blog/powered-by-ai-instagrams-explore-recommender-system/
* https://en.wikipedia.org/wiki/Multi-armed_bandit
* https://www.searchenginejournal.com/biases-search-recommender-systems/339319/#close
* https://link.springer.com/article/10.1007/s00146-020-00950-y
* https://www.computer.org/csdl/proceedings-article/big-data/2019/09005954/1hJsfgT0qL6
* https://daiwk.github.io/assets/youtube-multitask.pdf

